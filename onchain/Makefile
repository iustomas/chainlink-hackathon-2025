NETWORK=base
MODULE=IntakePayment
CHAIN_ID=8453
DEPLOYMENT_FILE=ignition/deployments/chain-$(CHAIN_ID)/deployed_addresses.json

# Install dependencies
install:
	@echo "ğŸ” Installing dependencies..."
	@npm install
	@echo "âœ… Dependencies installed!"

# Compile command
compile:
	@echo "ğŸ’» Compiling smart contracts..."
	@npx hardhat compile
	@echo "âœ… Compilation completed!"

# Clean command
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	@rm -rf build/ artifacts/ cache/ typechain-types/
	@echo "âœ… Clean completed!"

# Test command
test:
	@echo "ğŸ§ª Running tests..."
	@npx hardhat test
	@echo "âœ… Tests completed!"

# Deploy command with verification
deploy:
	@echo "ğŸš€ Starting full deployment & verification process..."
	@echo "âš ï¸  Are you sure you want to deploy to $(NETWORK)? (Yes/No)"
	@read -p "> " confirm; \
	if [ "$$confirm" != "Yes" ]; then \
		echo "âŒ Deployment cancelled"; \
		exit 1; \
	fi
	@npx hardhat ignition deploy ignition/modules/$(MODULE).ts --network $(NETWORK)
	@echo "ğŸ“¡ Extracting deployed contract address from deployed_addresses.json..."
	@ADDRESS=$$(cat $(DEPLOYMENT_FILE) | jq -r '.["$(MODULE)#$(MODULE)"]'); \
	if [ -z "$$ADDRESS" ]; then \
		echo "âŒ Failed to get contract address"; \
		exit 1; \
	fi; \
	echo "âœ… Contract deployed at: $$ADDRESS"; \
	echo "ğŸ” Verifying smart contract..."; \
	npx hardhat verify --network $(NETWORK) $$ADDRESS "0x71041dddad3595F9CEd3DcCFBe3D1F4b0a16Bb70"
	@echo "ğŸ¯ All done!"

.PHONY: compile clean test deploy
